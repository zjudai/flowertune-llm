# Flower-NLP 联邦学习框架

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         Flower-NLP 框架                          │
└───────────────────────────────┬─────────────────────────────────┘
                                │
    ┌───────────────────────────┼───────────────────────────┐
    │                           │                           │
┌───▼───────────────┐    ┌─────▼─────────┐         ┌───────▼───────┐
│    ServerApp      │    │   ClientApp   │         │    数据集      │
│  (server_app.py)  │◄───┼──►(client_app.py)       │  (dataset.py) │
└──────┬────────────┘    └─────┬─────────┘         └───────┬───────┘
       │                       │                           │
       │                       │                           │
┌──────▼────────────┐    ┌─────▼─────────┐         ┌───────▼───────┐
│     策略模块       │    │   客户端模块    │         │   数据处理     │
│   (strategy.py)   │    │ (FlowerClient)│         │    模块       │
└──────┬────────────┘    └─────┬─────────┘         └───────────────┘
       │                       │
       │                       │
       └───────────┬───────────┘
                   │
             ┌─────▼─────┐
             │ 模型模块   │
             │(models.py)│
             └───────────┘
```

## 模块说明

### 1. 服务器模块 (server_app.py)
- **主要功能**: 配置和启动联邦学习服务器
- **核心组件**:
  - `ServerApp`: Flower服务器应用入口
  - `server_fn`: 服务器配置函数
  - `get_evaluate_fn`: 创建模型评估和保存函数
  - `get_on_fit_config`: 生成客户端训练配置
  - `fit_weighted_average`: 聚合联邦评估指标

### 2. 客户端模块 (client_app.py)
- **主要功能**: 配置和启动联邦学习客户端
- **核心组件**:
  - `ClientApp`: Flower客户端应用入口
  - `client_fn`: 客户端配置函数
  - `FlowerClient`: 实现本地训练逻辑的客户端类

### 3. 策略模块 (strategy.py)
- **主要功能**: 定义联邦学习策略
- **核心组件**:
  - `FlowerTuneLlm`: 继承自FedAvg的自定义联邦学习策略
  - `CommunicationTracker`: 通信成本跟踪器

### 4. 模型模块 (models.py)
- **主要功能**: 模型管理和参数处理
- **核心组件**:
  - `get_model`: 加载和配置预训练模型
  - `set_parameters`: 设置模型参数
  - `get_parameters`: 获取模型参数
  - `cosine_annealing`: 余弦退火学习率调度

### 5. 数据集模块 (dataset.py)
- **主要功能**: 数据加载和预处理
- **核心组件**:
  - `load_data`: 加载分区数据
  - `formatting_prompts_func`: 构建提示格式
  - `reformat`: 重新格式化数据集
  - `get_tokenizer_and_data_collator_and_propt_formatting`: 获取分词器和数据整理器

## 数据流程

1. **初始化阶段**:
   - 服务器初始化全局模型和联邦学习策略
   - 客户端加载各自的数据分区

2. **训练阶段**:
   ```
   服务器 ──(全局模型参数)──► 客户端
           ◄──(更新后参数)── 客户端执行本地训练
   ```

3. **聚合阶段**:
   - 服务器接收所有客户端的模型更新
   - 使用加权平均方法聚合参数
   - 更新全局模型

4. **评估与保存阶段**:
   - 在特定轮次，服务器保存全局模型检查点

## 技术特点

1. **模型优化**:
   - 使用LoRA参数高效微调
   - 支持4位和8位量化，减少内存需求
   - 应用余弦退火学习率调度

2. **通信效率**:
   - 跟踪和监控通信成本
   - 提供通信预算警告

3. **数据处理**:
   - 支持不同NLP任务的数据格式化
   - 使用IID分区器均匀划分数据

4. **框架集成**:
   - 与Hugging Face Transformers深度集成
   - 利用TRL进行指令微调 